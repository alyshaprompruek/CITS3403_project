<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Dashboard | Grade Tracker</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body class="container py-4">
  <!-- Navigation Bar -->
  <nav class="navbar navbar-expand-lg navbar-light bg-white mb-4">
    <div class="container-fluid">  
      <a class="navbar-brand" href="#">Grade Tracker</a>
      <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
        <span class="navbar-toggler-icon"></span>
      </button>
      <div class="collapse navbar-collapse" id="navbarNav">
        <ul class="navbar-nav justify-content-center w-100">
          <li class="nav-item">
            <a class="nav-link text-dark active" href="/dashboard">Dashboard</a>
          </li>
          <li class="nav-item">
            <a class="nav-link text-dark" href="/course">Units</a>
          </li>
        </ul>
      </div>
      <div class="ms-auto d-flex align-items-center">
        <div class="rounded-circle bg-secondary text-white d-flex justify-content-center align-items-center" style="width: 40px; height: 40px;">A</div>
      </div>
    </div>
  </nav>

  <h1 class="mb-4">Welcome back, Admin!</h1>

  <!-- Summary Table -->
  <div class="mb-4">
    <h3>Summary</h3>
    <table class="table table-bordered">
      <tbody>
        <tr><th>WAM</th><td id="wam"></td></tr>
        <tr><th>GPA</th><td id="gpa"></td></tr>
        <tr><th>Top Unit</th><td id="topUnit"></td></tr>
      </tbody>
    </table>
  </div>

  <!-- Unit Goals Table -->
  <div class="mb-4">
    <h3>Unit Goals</h3>
    <table class="table table-striped">
      <thead>
        <tr><th>Unit</th><th>Target</th><th>Actual</th><th>Difference</th></tr>
      </thead>
      <tbody id="goalTableBody"></tbody>
    </table>
  </div>

  <!-- Upcoming Assessments -->
  <div class="mb-4">
    <h3>Upcoming Assessments</h3>
    <table class="table table-hover">
      <thead>
        <tr><th>Unit</th><th>Task</th><th>Due Date</th></tr>
      </thead>
      <tbody id="upcomingTableBody"></tbody>
    </table>
  </div>

  <!-- Charts -->
  <div>
    <h3>Progress Overview</h3>
    <canvas id="progressChart" height="100"></canvas>
  </div>

  <script>
    window.onload = () => {
      fetch('/api/units')
        .then(res => res.json())
        .then(units => {
          updateDashboard(units);
        })
        .catch(err => {
          console.error("error", err);
        });
    };

    function updateDashboard(units) {
      const allScores = units.flatMap(u => u.assessments.map(a => Number(a.score)));
      const wam = (allScores.reduce((a, b) => a + b, 0) / allScores.length).toFixed(2);
      const gpa = (wam / 20).toFixed(2);

      const topUnit = units
        .map(u => ({ name: u.unit_name, avg: u.assessments.length > 0 ? u.assessments.reduce((s, a) => s + Number(a.score), 0) / u.assessments.length : 0 }))
        .sort((a, b) => b.avg - a.avg)[0];

      document.getElementById("wam").textContent = wam;
      document.getElementById("gpa").textContent = gpa;
      document.getElementById("topUnit").textContent = topUnit.name;

      const goalTable = document.getElementById("goalTableBody");
      goalTable.innerHTML = "";
      units.forEach(unit => {
        let weightedSum = 0;
        unit.assessments.forEach(a => {
          const score = Number(a.score);
          const weight = parseFloat(a.weight.replace('%', '')) / 100;//????????holy this is so wrong we need more detail for each assessment. pls check my issues#16
          if (!isNaN(score) && !isNaN(weight)) {
            weightedSum += score * weight* 10; //????what im i doing im so sleepy goodnight
          }
        });
        const actual = weightedSum;
        const diff = (actual - unit.target_score).toFixed(2);
        const row = document.createElement("tr");
        row.innerHTML = `
          <td>${unit.unit_name}</td>
          <td>${unit.target_score}</td>
          <td>${actual.toFixed(2)}</td>
          <td style="color:${diff >= 0 ? 'green' : 'red'};">${diff >= 0 ? '+' : ''}${diff}</td>
        `;
        goalTable.appendChild(row);
      });

      const upcoming = units.flatMap(unit => unit.assessments.map(a => ({ unit: unit.unit_name, task: a.task_name, date: new Date(a.date) }))).sort((a, b) => a.date - b.date);

      const upcomingTable = document.getElementById("upcomingTableBody");
      upcomingTable.innerHTML = "";
      upcoming.forEach(a => {
        const row = document.createElement("tr");
        row.innerHTML = `<td>${a.unit}</td><td>${a.task}</td><td>${a.date.toISOString().split('T')[0]}</td>`;
        upcomingTable.appendChild(row);
      });

      const ctx = document.getElementById("progressChart").getContext("2d");
      new Chart(ctx, {
        type: "line",
        data: {
          labels: units.map(u => u.unit_name),
          datasets: [{
            label: "scores",
            data: units.map(u => u.assessments.length > 0 ? u.assessments.reduce((s, a) => s + Number(a.score), 0) / u.assessments.length : 0),
            fill: false,
            borderColor: "blue",
            tension: 0.2
          }]
        },
        options: {
          responsive: true,
          scales: {
            y: {
              beginAtZero: true,
              max: 100
            }
          }
        }
      });
    }
  </script>
</body>
</html>
