{% extends "base.html" %}

{% block head %}
<title>Dashboard | Grade Tracker</title>
{% endblock %}

{% block body %}
<div class="container py-5">
    <!-- Summary Table -->
    <div class="card mb-4">
        <div class="card-header bg-primary text-white">
            <h5 class="mb-0">Summary</h5>
        </div>
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-bordered table-sm">
                    <tbody>
                        <tr>
                            <th scope="row">WAM</th>
                            <td>{{ user.wam | default('N/A', true) }}</td>
                        </tr>
                        <tr>
                            <th scope="row">GPA</th>
                            <td>{{ user.gpa | default('N/A', true) }}</td>
                        </tr>
                        <tr>
                            <th scope="row">Top Unit</th>
                            <td>{{ user.top_unit | default('N/A', true) }}</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Units Table -->
    <div class="card mb-4">
        <div class="card-header bg-primary text-white">
            <h5 class="mb-0">Units</h5>
        </div>
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-bordered table-hover">
                    <thead class="thead-light">
                        <tr>
                            <th scope="col">Rank</th>
                            <th scope="col">Year | Sem</th>
                            <th scope="col">Unit Name</th>
                            <th scope="col">Unit Code</th>
                            <th scope="col">Target Grade</th> <!-- New column for target grade -->
                            <th scope="col">Grade</th>
                            <th scope="col">Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for item in unit_scores %}
                          {% set unit = item.unit %}
                          <tr>
                            <td>{{ loop.index }}</td>
                            <td>{{ unit.year }} | Sem {{ unit.semester }}</td>
                            <td>{{ unit.name }}</td>
                            <td>{{ unit.unit_code }}</td>
                            <td>
                              {% if unit.target_score == 80 %}
                                High Distinction
                              {% elif unit.target_score == 70 %}
                                Distinction
                              {% elif unit.target_score == 60 %}
                                Credit
                              {% elif unit.target_score == 50 %}
                                Pass
                              {% else %}
                                N/A
                              {% endif %}
                            </td>
                            <td>{{ item.score | default('N/A', true) }}</td>
                            <td>
                              <button class="btn btn-sm btn-outline-primary"
                                  data-bs-toggle="modal"
                                  data-bs-target="#editUnitModal"
                                  data-unit-id="{{ unit.id }}"
                                  data-unit-name="{{ unit.name }}"
                                  data-unit-code="{{ unit.unit_code }}"
                                  data-unit-grade="{{ item.score }}"
                                  data-unit-year="{{ unit.year }}"
                                  data-unit-target="{% if unit.target_score == 80 %}HD{% elif unit.target_score == 70 %}D{% elif unit.target_score == 60 %}C{% elif unit.target_score == 50 %}P{% else %}N/A{% endif %}"
                                  data-unit-semester="{{ unit.semester }}">
                                  ✏️ Edit
                              </button>
                            </td>
                          </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Recommendations Section -->
    <div class="card mb-4">
        <div class="card-header bg-success text-white">
            <h5 class="mb-0">Target Recommendations</h5>
        </div>
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-bordered table-sm">
                    <thead>
                        <tr>
                            <th>Unit</th>
                            <th>Target Score</th>
                            <th>Current Score</th>
                            <th>Remaining Weight (%)</th>
                            <th>Required Avg in Remaining</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for rec in recommendations %}
                        <tr>
                            <td>{{ rec.unit_code }}</td>
                            <td>{{ rec.target }}</td>
                            <td>{{ rec.current_score }}</td>
                            <td>{{ rec.remaining_weight }}</td>
                            <td>{{ rec.required_score | default('N/A', true) }}</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>


    <!-- Progress Analysis Section -->
    <div class="card">
        <div class="card-header bg-primary text-white">
            <h5 class="mb-0">Progress Analysis</h5>
        </div>
        <div class="card-body">
            <p>AI-powered insights will help you track your academic progress and provide recommendations.</p>
            <div id="ai-recommendations" class="mb-3">
                <p class="text-muted">AI Recommendations will appear here...</p>
            </div>
            <button id="aiAnalyzeButton" class="btn btn-primary">Analyze Progress</button>
        </div>
    </div>
</div>

<!-- Edit Unit Modal -->
<div class="modal fade" id="editUnitModal" tabindex="-1" aria-labelledby="editUnitModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <form method="POST" action="{{ url_for('update_unit') }}">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="editUnitModalLabel">Edit Unit</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <input type="hidden" name="unit_id" id="editUnitId">
          <div class="mb-3">
            <label for="editUnitName" class="form-label">Unit Name</label>
            <input type="text" class="form-control" id="editUnitName" name="name" required>
          </div>
          <div class="mb-3">
            <label for="editUnitCode" class="form-label">Unit Code</label>
            <input type="text" class="form-control" id="editUnitCode" name="unit_code" required>
          </div>
          <div class="mb-3">
            <label for="editUnitYear" class="form-label">Year of Completion</label>
            <input type="number" class="form-control" id="editUnitYear" name="year" required>
          </div>
          <div class="mb-3">
            <label for="editUnitSemester" class="form-label">Semester</label>
            <input type="text" class="form-control" id="editUnitSemester" name="semester" required>
          </div>
          <!-- Add Target Grade Selection -->
          <div class="mb-3">
            <label for="editUnitTargetGrade" class="form-label">Target Grade</label>
              <select class="form-select" id="editUnitTargetGrade" name="target_score" required>
              <option value="HD">High Distinction (80-100%)</option>
              <option value="D">Distinction (70-79%)</option>
              <option value="C">Credit (60-69%)</option>
              <option value="P">Pass (50-59%)</option>
            </select>

          </div>
        </div>
        <div class="modal-footer">
          <button type="submit" class="btn btn-primary">Save Changes</button>
        </div>
      </div>
    </form>
  </div>
</div>

<!-- Modal Script -->
<script>
  const editModal = document.getElementById('editUnitModal');
  editModal.addEventListener('show.bs.modal', event => {
    const button = event.relatedTarget;
    document.getElementById('editUnitId').value = button.getAttribute('data-unit-id');
    document.getElementById('editUnitName').value = button.getAttribute('data-unit-name');
    document.getElementById('editUnitCode').value = button.getAttribute('data-unit-code');
    document.getElementById('editUnitYear').value = button.getAttribute('data-unit-year');
    document.getElementById('editUnitTargetGrade').value = button.getAttribute('data-unit-target');
    document.getElementById('editUnitSemester').value = button.getAttribute('data-unit-semester');

     // Populate the target grade dropdown
    const targetGrade = button.getAttribute('data-unit-target');
    const targetGradeDropdown = document.getElementById('editUnitTargetGrade');
    targetGradeDropdown.value = targetGrade;
    
  });
</script>
{% endblock %}
