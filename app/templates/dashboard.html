{% extends "base.html" %}

{% block head %}
<title>Dashboard | Grade Tracker</title>
{% endblock %}

{% block body %}
<div class="container py-5">
  <!-- Flash Messages -->
  {% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
      {% for category, message in messages %}
        <div class="alert alert-{{ category }} alert-dismissible fade show m-3" role="alert">
          {{ message }}
          <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
      {% endfor %}
    {% endif %}
  {% endwith %}

  {% if readonly_view and shared_from %}
    <div class="alert alert-info text-center mb-4">
      You are viewing {{ shared_from }}'s dashboard.
    </div>
  {% endif %}

  <!-- Summary -->
  <div class="card mb-4">
    <div class="card-header bg-primary text-white">
      <h5 class="mb-0">Summary</h5>
    </div>
    <div class="card-body">
      <table class="table table-bordered table-sm mb-0">
        <tbody>
          <tr>
            <th scope="row">WAM</th>
            <td>
              {{ (wam if readonly_view else user.wam) | round(2) if (wam if readonly_view else user.wam) is not none else 'N/A' }}
            </td>
          </tr>
          <tr>
            <th scope="row">GPA</th>
            <td>
              {{ (gpa if readonly_view else user.gpa) | round(2) if (gpa if readonly_view else user.gpa) is not none else 'N/A' }}
            </td>
          </tr>
          <tr>
            <th scope="row">Top Unit</th>
            <td>{{ (top_unit if readonly_view else user.top_unit) | default('N/A', true) }}</td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>

  <!-- Units Table -->
  <div class="card mb-4">
    <div class="card-header bg-primary text-white">
      <h5 class="mb-0">Units</h5>
    </div>
    <div class="card-body">
      <div class="table-responsive">
        <table class="table table-bordered table-hover table-sm">
          <thead class="table-light">
            <tr>
              <th>Rank</th>
              <th>Year | Sem</th>
              <th>Unit Name</th>
              <th>Unit Code</th>
              <th>Target Grade</th>
              <th>Grade</th>
            </tr>
          </thead>
          <tbody>
            {% for item in unit_scores %}
              {% set unit = item.unit %}
              {% if not shared_unit_id or shared_unit_id == unit.id %}
                <tr>
                  <td>{{ loop.index }}</td>
                  <td>{{ unit.year }} | Sem {{ unit.semester }}</td>
                  <td>{{ unit.name }}</td>
                  <td>{{ unit.unit_code }}</td>
                  <td>{{ unit.target_score if unit.target_score else 'Not Set' }}</td>
                  <td>{{ item.score | round(0, 'floor') | int if item.score is not none else 'N/A' }}</td>
                </tr>
              {% endif %}
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- Recommendations -->
  <div class="card mb-4">
    <div class="card-header bg-success text-white">
      <h5 class="mb-0">Target Recommendations</h5>
    </div>
    <div class="card-body">
      <div class="table-responsive">
        <table class="table table-bordered table-sm">
          <thead>
            <tr>
              <th>Unit</th>
              <th>Target Score</th>
              <th>Current Score</th>
              <th>Remaining Weight (%)</th>
              <th>Required Avg in Remaining</th>
            </tr>
          </thead>
          <tbody>
            {% for rec in recommendations %}
              {% if not shared_unit_id or shared_unit_id == rec.unit_id %}
                <tr>
                  <td>{{ rec.unit_code }}</td>
                  <td>{{ rec.target if rec.target else 'Not Set' }}</td>
                  <td>{{ rec.current_score | default('N/A', true) }}</td>
                  <td>{{ rec.remaining_weight | default('N/A', true) }}</td>
                  <td>{{ rec.required_score | default('N/A', true) }}</td>
                </tr>
              {% endif %}
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- Edit Unit Modal -->
  {% if editUnitForm %}
    <div class="modal fade" id="editUnitModal" tabindex="-1" aria-labelledby="editUnitModalLabel" aria-hidden="true">
      <div class="modal-dialog">
        <form method="POST" action="{{ url_for('update_unit') }}">
          {{ editUnitForm.hidden_tag() }}
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title" id="editUnitModalLabel">Edit Unit</h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
              {{ editUnitForm.unit_id(id="editUnitId") }}
              <div class="mb-3">
                <label for="editUnitName" class="form-label">{{ editUnitForm.name.label }}</label>
                {{ editUnitForm.name(class="form-control", id="editUnitName") }}
              </div>
              <div class="mb-3">
                <label for="editUnitCode" class="form-label">{{ editUnitForm.unit_code.label }}</label>
                {{ editUnitForm.unit_code(class="form-control", id="editUnitCode") }}
              </div>
              <div class="mb-3">
                <label for="editUnitYear" class="form-label">{{ editUnitForm.year.label }}</label>
                {{ editUnitForm.year(class="form-select", id="editUnitYear") }}
              </div>
              <div class="mb-3">
                <label for="editUnitSemester" class="form-label">{{ editUnitForm.semester.label }}</label>
                {{ editUnitForm.semester(class="form-select", id="editUnitSemester") }}
              </div>
              <div class="mb-3">
                <label for="editUnitTargetScore" class="form-label">{{ editUnitForm.target_score.label }}</label>
                {{ editUnitForm.target_score(class="form-control", id="editUnitTargetScore") }}
              </div>
            </div>
            <div class="modal-footer">
              {{ editUnitForm.submit(class="btn btn-primary") }}
              <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
            </div>
          </div>
        </form>
      </div>
    </div>
  {% endif %}
</div>

<!-- Script to populate Edit Modal -->
<script>
  document.addEventListener('DOMContentLoaded', function () {
    const modal = document.getElementById('editUnitModal');

    if (modal) {
      modal.addEventListener('show.bs.modal', function (event) {
        const button = event.relatedTarget;
        const data = {
          unit_id: button.getAttribute('data-unit-id'),
          name: button.getAttribute('data-unit-name'),
          code: button.getAttribute('data-unit-code'),
          year: button.getAttribute('data-unit-year'),
          semester: button.getAttribute('data-unit-semester'),
          target: button.getAttribute('data-unit-target')
        };

        const idField = document.querySelector('#editUnitModal input[name="unit_id"]');
        const nameField = document.getElementById('editUnitName');
        const codeField = document.getElementById('editUnitCode');
        const yearField = document.getElementById('editUnitYear');
        const semesterField = document.getElementById('editUnitSemester');
        const targetField = document.getElementById('editUnitTargetScore');

        if (idField) idField.value = data.unit_id || '';
        if (nameField) nameField.value = data.name || '';
        if (codeField) codeField.value = data.code || '';
        if (yearField) yearField.value = data.year || '';
        if (semesterField) semesterField.value = data.semester || '';
        if (targetField) targetField.value = data.target || '';
      });
    }
  });
</script>
{% endblock %}
