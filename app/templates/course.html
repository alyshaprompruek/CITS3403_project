<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Courses | Grade Tracker</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns"></script>

  <style>
    .hidden { display: none; }
    aside button { display: block; margin-bottom: 5px; }
  </style>
</head>
<body>
  <!-- Navigation Bar -->
  <nav class="navbar navbar-expand-lg navbar-light bg-white mb-4">
      <div class="container-fluid">  
          <a class="navbar-brand" href="#">Grade Tracker</a>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
              <span class="navbar-toggler-icon"></span>
          </button>
          <div class="collapse navbar-collapse" id="navbarNav">
              <ul class="navbar-nav justify-content-center w-100">
                  <li class="nav-item">
                      <a class="nav-link text-dark" href="dashboard.html">Dashboard</a>
                  </li>
                  <li class="nav-item">
                      <a class="nav-link text-dark" href="course.html">Units</a>
                  </li>
              </ul>
          </div>
          <div class="ms-auto d-flex align-items-center">
              <div class="rounded-circle bg-secondary" 
                   style="width: 40px; height: 40px;">
              </div>
          </div>
      </div>
  </nav>

  <main style="display: flex; height: 90vh;">
    <aside style="width: 20%; border-right: 1px solid #ccc; padding: 10px;">
      <h3>UNIT</h3>
      <button onclick="simulateAddUnit()">+ new unit</button>
      <div id="unitList"></div>
    </aside>

    <section style="width: 80%; padding: 20px;">
      <div id="noUnitBox">
        <h2>you hvnt create any units yet</h2>
        <button onclick="simulateAddUnit()">➕ new unit</button>
      </div>

      <div id="courseContent" class="hidden">
        <h2 id="currentUnitTitle"></h2>

        <!-- Unit Outline Link -->
        <div style="margin-bottom: 20px;">
            <a id="unitOutlineLink" href="https://www.uwa.edu.au/placeholder-unit-outline" target="_blank" class="btn btn-primary">
                View Unit Outline
            </a>
        </div>

        <div style="display: flex; justify-content: space-between; margin-bottom: 30px;">
          <div style="width: 48%;">
            <canvas id="lineChart" height="200"></canvas>
          </div>
          <div style="width: 48%;">
            <canvas id="pieChart" height="200"></canvas>
          </div>
        </div>

        <h2>Assessment List</h2>
        <button style="margin-bottom: 10px;">➕ new Assessment</button>
        <table border="1" cellpadding="8" cellspacing="0" width="100%" id="assessmentTable">
          <thead>
            <tr style="background-color: #f2f2f2;">
              <th>Task</th>
              <th>Score</th>
              <th>Weight</th>
              <th>Date</th>
              <th>Note</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </section>
  </main>

  <!---------------mock data---------------->
  <script>
  

    let currentUser = { name: "Admin" }; 
    let currentUnit = null;
    let lineChart, pieChart;

    // get mock data form mockData.js
    window.onload = () => {
      fetch('/api/units')
        .then(res => res.json())
        .then(units => {
          currentUser.units = units;  
          if (units.length > 0) {
            currentUnit = units[0];   
          }
          updateView();
        })
        .catch(err => {
        console.error("❌ Failed to fetch units:", err);
        // fallback to mockData if needed
        currentUser.units = mockData.admin.units;
        currentUnit = currentUser.units[0];
        updateView();
        });
    };

    function simulateAddUnit() {
      const name = prompt("unit name:", "New Unit");
      if (!name || name.trim() === "") return;
      const unit = {
        unit_id: "u" + (currentUser.units.length + 1),
        unit_name: name.trim(),
        target_score: 80,
        assessments: []
      };
      currentUser.units.push(unit);
      selectUnit(unit);
      updateView();
    }

    function selectUnit(unit) {
      currentUnit = unit;
      updateView();
    }

    function updateView() {
      const unitList = document.getElementById("unitList");
      const noUnitBox = document.getElementById("noUnitBox");
      const courseContent = document.getElementById("courseContent");
      const currentTitle = document.getElementById("currentUnitTitle");
      const tableBody = document.querySelector("#assessmentTable tbody");

      unitList.innerHTML = "";
      currentUser.units.forEach(unit => {
        const btn = document.createElement("button");
        btn.textContent = unit.unit_name;
        btn.onclick = () => selectUnit(unit);
        unitList.appendChild(btn);
      });

      if (!currentUnit) {
        noUnitBox.classList.remove("hidden");
        courseContent.classList.add("hidden");
      } else {
        noUnitBox.classList.add("hidden");
        courseContent.classList.remove("hidden");
        currentTitle.textContent = currentUnit.unit_name;

        tableBody.innerHTML = "";
        currentUnit.assessments.forEach(a => {
          const row = document.createElement("tr");
          row.innerHTML = `
            <td>${a.task_name}</td>
            <td>${a.score}</td>
            <td>${a.weight}</td>
            <td>${a.date}</td>
            <td>${a.note}</td>
          `;
          tableBody.appendChild(row);
        });

        renderCharts(currentUnit.assessments);
      }
    }

    function renderCharts(assessments) {
      const lineCtx = document.getElementById("lineChart").getContext("2d");
      const pieCtx = document.getElementById("pieChart").getContext("2d");

      const lineData = assessments.filter(a => a.score !== "/" && !isNaN(Number(a.score)))
        .map(a => ({ x: a.date, y: Number(a.score) }));

      const pieData = assessments.map(a => ({
        label: a.task_name,
        value: parseFloat(a.weight.replace("%", ""))
      }));

      if (lineChart) lineChart.destroy();
      if (pieChart) pieChart.destroy();

      lineChart = new Chart(lineCtx, {
        type: 'line',
        data: {
          datasets: [{
            label: "Score Over Time",
            data: lineData,
            fill: false,
            borderColor: 'blue'
          }]
        },
        options: {
            responsive: true,
            plugins: {
                legend: {
                    onClick: () => {},  // disable clicking
                    labels: {
                        color: '#000',
                        boxWidth: 12,
                        font: { weight: 'bold' }
                        }
                    }
                
        },
        scales: { x: { type: 'time', time: { unit: 'day' } } }
        }
      });

      pieChart = new Chart(pieCtx, {
        type: 'pie',
        data: {
          labels: pieData.map(p => p.label),
          datasets: [{
            data: pieData.map(p => p.value),
            backgroundColor: ["#FF6384", "#36A2EB", "#FFCE56", "#4BC0C0"]
          }]
        },
        options: {
          responsive: true,
          plugins: {
            legend: {
              position: 'bottom',
              onClick: () => {}, // disable clicking
              labels: {
                color: '#000',
                font: { size: 12 }
              }
            }
          }
        }
      });
    }

    //window.onload have been rewritten 
  </script>
</body>
</html>
