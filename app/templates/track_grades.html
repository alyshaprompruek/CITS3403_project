{% extends "base.html" %}

{% block head %}
    <title>Track Grades</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation@1.4.0"></script>
    <script src="{{ url_for('static', filename='track_grades.js') }}"></script>
{% endblock %}

{% block body %}
<div class="container py-5">
    <h2 class="text-center mb-4">Track Your Grades</h2>

    <div class="row">
        <!-- Left Panel -->
        <div class="col-md-4">
            <div class="card shadow-sm mb-4">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0">Units</h5>
                </div>
                <div class="card-body p-0">
                    <!-- Unit list with proper spacing -->
                    <div id="unitList" class="list-group list-group-flush">
                        <!-- Units will be dynamically populated by JavaScript -->
                    </div>
                    
                    <!-- Success message with proper spacing -->
                    {% if success %}
                        <div class="alert alert-success m-3 mb-0" role="alert">
                            {{ success }}
                        </div>
                    {% endif %}
                    
                    <!-- Error message if present -->
                    {% if error %}
                        <div class="alert alert-danger m-3 mb-0" role="alert">
                            {{ error }}
                        </div>
                    {% endif %}
    
                    <!-- Add Unit Form with better spacing -->
                    <div class="p-3 mt-3 border-top">
                        <h4 class="mb-2">Add a New Unit:</h4>
                        <p class="text-muted mb-3" style="font-size: 0.9rem;">
                            You can update unit details later from the <a href="{{ url_for('dashboard') }}">dashboard</a>.
                        </p>
                        <form action="{{ url_for('add_unit') }}" method="post">
                            {{ form.csrf_token }}
                            
                            <div class="mb-3">
                                {{ form.name.label(class="form-label fw-medium") }}
                                {{ form.name(class="form-control") }}
                            </div>
                            
                            <div class="mb-3">
                                {{ form.unit_code.label(class="form-label fw-medium") }}
                                {{ form.unit_code(class="form-control") }}
                            </div>
                            
                            <div class="mb-3">
                                {{ form.semester.label(class="form-label fw-medium") }}
                                {{ form.semester(class="form-select") }}
                            </div>
                            
                            <div class="mb-3">
                                {{ form.year.label(class="form-label fw-medium") }}
                                {{ form.year(class="form-select") }}
                            </div>

                            <!-- Add the Target Score field -->
                            <div class="mb-3">
                                {{ form.target_score.label(class="form-label fw-medium") }}
                                {{ form.target_score(class="form-select") }}
                            </div>
                            
                            <div class="d-grid">
                                {{ form.submit(class="btn btn-primary") }}
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>

        <!-- Right Panel -->
        <div class="col-md-8">
            <div id="courseContent" class="card shadow-sm">
                <div class="card-header bg-primary text-white">
                    <h5 id="currentUnitTitle" class="mb-0">Unit Details</h5>
                </div>
                <div class="card-body">
                    <!-- Message when no units are added -->
                    <div id="noUnitBox" class="alert alert-info text-center">
                        <p>No units added. Please add a unit to get started.</p>
                    </div>

                    <!-- Message when units exist but none are selected -->
                    <div id="selectUnitBox" class="alert alert-warning text-center hidden">
                        <p>Please select a unit to display its details.</p>
                    </div>

                    <!-- Assessment content -->
                    <div id="assessmentContent">
                        <table id="assessmentTable" class="table table-bordered table-hover">
                            <thead class="table-light">
                                <tr>
                                    <th>Task Name</th>
                                    <th>Score</th>
                                    <th>Weight</th>
                                    <th>Date</th>
                                    <th>Note</th>
                                </tr>
                            </thead>
                            <tbody>
                                <!-- Assessment rows will be dynamically populated here -->
                            </tbody>
                        </table>
                        <button class="btn btn-primary mt-3" onclick="openAssessmentModal()">Add Assessment</button>
                    </div>
                    
                    <!-- Charts -->
                    <div id="charts" class="mt-4">
                        <canvas id="lineChart"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal for Adding Unit -->
    <div id="unitModal" class="modal hidden">
        <div class="modal-content bg-dark text-white">
            <h3 class="mb-4 text-center">Add New Unit</h3>
            <div class="form-group mb-4">
                <input type="text" id="unitNameInput" class="form-control bg-dark text-white border-secondary" placeholder="Enter Unit Name" />
            </div>
            <div class="d-flex justify-content-between">
                <button class="btn btn-primary px-4" onclick="confirmAddUnit()">Confirm</button>
                <button class="btn btn-secondary px-4" onclick="closeUnitModal()">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Modal for Adding Assessment -->
<div id="assessmentModal" class="modal hidden">
    <div class="modal-content bg-dark text-white">
        <h4 class="mb-2 text-start fw-bold">Add a New Assessment:</h4>
        <p class="text-muted mb-4 text-start" style="font-size: 0.9rem;">
            You can edit assessment details later by clicking on them in the table.
        </p>

        <div class="form-group mb-3 text-start">
            <label for="taskNameInput" class="form-label fw-medium">Task Name</label>
            <input type="text" id="taskNameInput" class="form-control bg-dark text-white border-secondary" placeholder="Enter Task Name" />
        </div>

        <div class="form-group mb-3 text-start">
            <label for="assessmentTypeDropdown" class="form-label fw-medium">Assessment Type</label>
            <select id="assessmentTypeDropdown" class="form-select bg-dark text-white border-secondary">
                <option value="" disabled selected>Select Assessment Type</option>
                <option value="test">Test</option>
                <option value="quiz">Quiz</option>
                <option value="lab">Lab</option>
                <option value="assignment">Assignment</option>
                <option value="exam">Exam</option>
                <option value="other">Other</option>
            </select>
        </div>


        <div class="form-group mb-3 text-start">
            <label for="scoreInput" class="form-label fw-medium">Score</label>
            <input type="text" id="scoreInput" class="form-control bg-dark text-white border-secondary" placeholder="e.g., 85" />
        </div>

        <div class="form-group mb-3 text-start">
            <label for="weightInput" class="form-label fw-medium">Weight</label>
            <input type="text" id="weightInput" class="form-control bg-dark text-white border-secondary" placeholder="e.g., 20%" />
        </div>

        <div class="form-group mb-3 text-start">
            <label for="dateInput" class="form-label fw-medium">Date</label>
            <input type="date" id="dateInput" class="form-control bg-dark text-white border-secondary" />
        </div>

        <div class="form-group mb-4 text-start">
            <label for="noteInput" class="form-label fw-medium">Note (optional)</label>
            <input type="text" id="noteInput" class="form-control bg-dark text-white border-secondary" placeholder="Any additional note" />
        </div>

        <div class="d-flex justify-content-between">
            <button class="btn btn-primary px-4" onclick="confirmAddAssessment()">Confirm</button>
            <button class="btn btn-secondary px-4" onclick="closeAssessmentModal()">Cancel</button>
        </div>
    </div>
</div>

<!-- Modal for Editing Assessment -->
<div id="editAssessmentModal" class="modal hidden">
    <div class="modal-content bg-dark text-white">
        <h4 class="mb-2 text-start fw-bold">Edit Assessment:</h4>
        <p class="text-muted mb-4 text-start" style="font-size: 0.9rem;">
            Update the fields below to modify your assessment details.
        </p>

        <div class="form-group mb-3 text-start">
            <label for="editTaskNameInput" class="form-label fw-medium">Task Name</label>
            <input type="text" id="editTaskNameInput" class="form-control bg-dark text-white border-secondary" />
        </div>

        <div class="form-group mb-3 text-start">
            <label for="editAssessmentTypeDropdown" class="form-label fw-medium">Assessment Type</label>
            <select id="editAssessmentTypeDropdown" class="form-select bg-dark text-white border-secondary">
                <option value="test">Test</option>
                <option value="quiz">Quiz</option>
                <option value="lab">Lab</option>
                <option value="assignment">Assignment</option>
                <option value="exam">Exam</option>
                <option value="other">Other</option>
            </select>
        </div>


        <div class="form-group mb-3 text-start">
            <label for="editScoreInput" class="form-label fw-medium">Score</label>
            <input type="text" id="editScoreInput" class="form-control bg-dark text-white border-secondary" />
        </div>

        <div class="form-group mb-3 text-start">
            <label for="editWeightInput" class="form-label fw-medium">Weight</label>
            <input type="text" id="editWeightInput" class="form-control bg-dark text-white border-secondary" />
        </div>

        <div class="form-group mb-3 text-start">
            <label for="editDateInput" class="form-label fw-medium">Date</label>
            <input type="date" id="editDateInput" class="form-control bg-dark text-white border-secondary" />
        </div>

        <div class="form-group mb-4 text-start">
            <label for="editNoteInput" class="form-label fw-medium">Note (optional)</label>
            <input type="text" id="editNoteInput" class="form-control bg-dark text-white border-secondary" />
        </div>

        <div class="d-flex justify-content-between">
            <button class="btn btn-primary px-4" onclick="confirmEditAssessment()">Confirm</button>
            <button class="btn btn-secondary px-4" onclick="closeEditAssessmentModal()">Cancel</button>
        </div>
    </div>
</div>


    <style>
    .modal {
        position: fixed;
        top: 0; left: 0;
        width: 100%; height: 100%;
        background: rgba(0,0,0,0.7);
        display: flex; align-items: center; justify-content: center;
        z-index: 1050;
    }
    .modal.hidden { 
        display: none; 
    }
    .modal-content {
        background: #212529;
        padding: 25px;
        border-radius: 10px;
        text-align: center;
        max-width: 500px;
        width: 90%;
        box-shadow: 0 0 20px rgba(0,0,0,0.5);
    }
    .hidden {
        display: none;
    }
    /* Custom styles for date picker in dark mode */
    input[type="date"]::-webkit-calendar-picker-indicator {
        filter: invert(1);
    }
    /* Style for select dropdown in dark mode */
    select.form-select option {
        background-color: #343a40;
    }
    </style>
</div>
{% endblock %}